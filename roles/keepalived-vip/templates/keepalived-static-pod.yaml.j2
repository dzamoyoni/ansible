apiVersion: v1
kind: Pod
metadata:
  name: keepalived-{{ inventory_hostname }}
  namespace: kube-system
  labels:
    component: keepalived
    tier: control-plane
  annotations:
    scheduler.alpha.kubernetes.io/critical-pod: ""
spec:
  containers:
  - name: keepalived
    image: osixia/keepalived:{{ keepalived.version }}
    imagePullPolicy: IfNotPresent
    env:
    - name: KEEPALIVED_INTERFACE
      value: {{ k8s_vip_interface }}
    - name: KEEPALIVED_UNICAST_PEERS
      value: "{{ groups['k8s_load_balancers'] | map('extract', hostvars, 'ansible_host') | join(' ') }}"
    - name: KEEPALIVED_VIRTUAL_IPS
      value: {{ k8s_vip }}
    - name: KEEPALIVED_PRIORITY
      value: "{{ keepalived_priority }}"
    - name: KEEPALIVED_STATE
      value: {{ keepalived_state }}
    volumeMounts:
    - mountPath: /usr/local/etc/keepalived/keepalived.conf
      name: keepalived-config
      readOnly: true
    - mountPath: /usr/local/bin/keepalived-notify.sh
      name: keepalived-notify
      readOnly: true
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
        - NET_BROADCAST
        - NET_RAW
      privileged: true
    livenessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "pgrep keepalived"
      initialDelaySeconds: 30
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3
    readinessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "pgrep keepalived && ip addr show | grep {{ k8s_vip }}"
      initialDelaySeconds: 15
      timeoutSeconds: 5
      periodSeconds: 5
      failureThreshold: 3
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  restartPolicy: Always
  volumes:
  - name: keepalived-config
    hostPath:
      path: /etc/keepalived-k8s/keepalived.conf
      type: File
  - name: keepalived-notify
    hostPath:
      path: /usr/local/bin/keepalived-notify.sh
      type: File
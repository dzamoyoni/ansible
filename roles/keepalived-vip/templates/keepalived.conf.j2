#---------------------------------------------------------------------
# Keepalived Configuration for Kubernetes HA Control Plane
# Generated by Ansible - Do not edit manually
#---------------------------------------------------------------------

! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL_{{ inventory_hostname | upper }}
    enable_script_security
    script_user root
}

# Health check script for API Server
vrrp_script chk_apiserver {
    script "/bin/bash -c 'curl -k -s https://127.0.0.1:6443/healthz >/dev/null && exit 0 || exit 1'"
    interval {{ keepalived.check_interval }}
    weight -2
    fall 3
    rise 2
    user root
}

# VRRP instance for Kubernetes VIP
vrrp_instance {{ keepalived.vrrp_instance_name }} {
    state {{ keepalived_state }}
    interface {{ k8s_vip_interface }}
    virtual_router_id 51
    priority {{ keepalived_priority }}
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass {{ keepalived.auth_pass }}
    }
    # Use unicast for better VMware/virtualized environment support
    unicast_src_ip {{ ansible_default_ipv4.address }}
    unicast_peer {
{% for host in groups['k8s_load_balancers'] %}
{% if hostvars[host].ansible_host != ansible_default_ipv4.address %}
        {{ hostvars[host].ansible_host }}
{% endif %}
{% endfor %}
    }
    virtual_ipaddress {
        {{ k8s_vip }}
    }
    track_script {
        chk_apiserver
    }
    notify_master /usr/local/bin/keepalived-notify.sh MASTER
    notify_backup /usr/local/bin/keepalived-notify.sh BACKUP
    notify_fault /usr/local/bin/keepalived-notify.sh FAULT
}

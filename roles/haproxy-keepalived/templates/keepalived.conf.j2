# ---------------------------------------------------------------------
# Keepalived Configuration for Kubernetes HA
# Generated by Ansible - Do not edit manually
# ---------------------------------------------------------------------

global_defs {
    router_id {{ inventory_hostname }}
    vrrp_version 3
    vrrp_iptables
    enable_script_security
}

# Health check script
vrrp_script check_apiserver {
    script "/bin/sh -c 'ss -tlnp | grep -q :{{ haproxy_frontend_port }}'"
    interval 3
    timeout 3
    fall 2
    rise 2
    weight -20
}

vrrp_instance VI_{{ keepalived_router_id | default('51') }} {
    state {{ keepalived_state }}
    interface {{ k8s_vip_interface }}
    virtual_router_id {{ keepalived_router_id | default('51') }}
    priority {{ keepalived_priority }}
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_auth_pass | default('k8s_ha_pass') }}
    }
    
    # Unicast configuration (recommended for modern networks)
    unicast_src_ip {{ ansible_default_ipv4.address }}
    unicast_peer {
{% for host in groups['k8s_control_plane'] %}
{% if host != inventory_hostname %}
        {{ hostvars[host].ansible_host }}
{% endif %}
{% endfor %}
    }
    
    virtual_ipaddress {
        {{ k8s_vip }}/{{ k8s_vip_netmask | default('32') }}
    }
    
    track_script {
        check_apiserver
    }
}


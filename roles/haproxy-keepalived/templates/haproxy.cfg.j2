    #---------------------------------------------------------------------
    # HAProxy Configuration for Kubernetes Stacked HA Control Plane
    # Generated by Ansible - Do not edit manually
    # CRITICAL FIX: Bind to *:6443 (0.0.0.0) NOT VIP - VIP doesn't exist yet!
    #---------------------------------------------------------------------

    global
        maxconn 4000
        log stdout local0
        stats socket /var/lib/haproxy/stats mode 660 level admin
        daemon

    defaults
        mode tcp
        log global
        option dontlognull
        option redispatch
        retries 3
        timeout connect 5s
        timeout client 30s
        timeout server 30s
        timeout check {{ haproxy_check_interval | default('3s') }}
        maxconn 3000

    #---------------------------------------------------------------------
    # HAProxy Statistics
    #---------------------------------------------------------------------
    listen stats
        bind *:{{ haproxy_stats_port }}
        mode http
        stats enable
        stats uri /stats
        stats realm HAProxy\ Statistics
        stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_pass }}
        stats refresh 30s
        stats hide-version
        stats show-node

    #---------------------------------------------------------------------
    # Kubernetes API Server Frontend
    # CRITICAL FIX: Bind to *:6443 (all interfaces including future VIP)
    # 
    # Why *:6443 instead of {{ k8s_vip }}:6443?
    # - VIP doesn't exist when HAProxy starts (Keepalived assigns it later)
    # - Binding to specific IP that doesn't exist = immediate crash
    # - Binding to 0.0.0.0 (*) = works immediately, also catches VIP traffic when assigned
    #---------------------------------------------------------------------
    frontend kubernetes-apiserver
        bind *:{{ haproxy_frontend_port }}
        mode tcp
        option tcplog
        timeout client 30s
        default_backend kubernetes-apiserver

    #---------------------------------------------------------------------
    # Kubernetes API Server Backend (Stacked HA Load Balancing)
    # Targets API server on port {{ kube_api_bind_port }} on all control planes
    #---------------------------------------------------------------------
    backend kubernetes-apiserver
        mode tcp
        balance roundrobin
        option tcp-check
        timeout server 30s
        timeout connect 5s
        
        # All control plane nodes - API server on {{ kube_api_bind_port }}
    {% for host in groups['k8s_control_plane'] %}
        server {{ hostvars[host].inventory_hostname }} {{ hostvars[host].ansible_host }}:{{ kube_api_bind_port }} check fall {{ haproxy_fall_count }} rise {{ haproxy_rise_count }} inter {{ haproxy_check_interval | default('3s') }}
    {% endfor %}

